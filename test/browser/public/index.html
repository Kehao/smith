<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Smith</title>
    <style>
      .passed {
        background-color: #8f8;
        color: #000;
      }
      .failed {
        background-color: #f22;
        color: #000;
        font-weight: bold;
      }
    </style>
</head>
<body>
    <h1>Smith</h1>

    <table>
      <thead>
        <tr>
          <th>Test</th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <script src="EventEmitter.js"></script>
    <script src="msgpack.js"></script>
    <script src="smith.js"></script>
    <script>


      var body = document.querySelector("tbody");
      var expectations = {};


      //////////////////////////////////////////////////////////////////////////

      var Agent = smith.Agent;
      var BrowserTransport = smith.BrowserTransport;

      assertEqual("typeof smith", "object", typeof smith);
      assertEqual("typeof smith.Agent", "function", typeof smith.Agent);
      assertEqual("typeof smith.BrowserTransport", "function", typeof smith.BrowserTransport);

      var agent = new Agent();

      assert("agent instanceof smith.Agent", agent instanceof smith.Agent);

      expect("socket opened");
      var ws = new WebSocket("ws://localhost:8080/");
      ws.onopen = function () {
        fulfill("socket opened");
        expect("agent connected");
        agent.connect(new BrowserTransport(ws, true), function (err, serverAgent) {
          if (err) return fail(err);
          fulfill("agent connected");
          assertEqual("typeof serverAgent", "object", typeof serverAgent);
          expect("called add");
          serverAgent.add(5, 7, function (err, result) {
            if (err) return fail(err);
            fulfill("called add");
            assertEqual("5 + 7", 12, result);
          });
        });
      };

      //////////////////////////////////////////////////////////////////////////

      function expect(name) {
        expectations[name] = setTimeout(function () {
          post("expected '" + name + "'", "timeout", false);
        }, 1000);
      }
      function fulfill(name) {
        post("expected '" + name + "'", name, true);
        clearTimeout(expectations[name]);
      }
      function fail(err) {
        post(err.message, err.stack, false);
      }
      function assert(name, value) {
        post(name, value, value);
      }
      function assertEqual(name, expected, actual) {
        post(name + " === " + expected, actual + " === " + expected, expected === actual);
      }

      function post(name, result, pass) {
        var tr = document.createElement('tr');
        tr.setAttribute("class", pass ? "passed" : "failed");
        var td = document.createElement('td');
        td.textContent = name;
        tr.appendChild(td);
        td = document.createElement('td');
        td.textContent = result;
        tr.appendChild(td);
        body.appendChild(tr);
      }

    </script>
</body>
</html>
